/*! Bergson 1.0.0, Copyright 2015 Colin Clark | github.com/colinbdclark/bergson */

!function(){"use strict";fluid.defaults("berg.clock",{gradeNames:["fluid.eventedComponent","autoInit"],rate:1,members:{time:0,rate:"{that}.options.rate",tickDuration:{expander:{funcName:"berg.clock.calcTickDuration",args:"{that}.options.rate"}}},invokers:{start:"fluid.identity()",tick:"fluid.identity()",stop:"fluid.identity()"},events:{onTick:null}}),berg.clock.calcTickDuration=function(a){return 1/a},fluid.defaults("berg.clock.offline",{gradeNames:["berg.clock","autoInit"],invokers:{tick:{funcName:"berg.clock.offline.tick",args:["{that}"]}}}),berg.clock.offline.round=function(a){return Math.round(1e14*a)/1e14},berg.clock.offline.tick=function(a){var b=a.time+a.tickDuration;a.time=berg.clock.offline.round(b),a.events.onTick.fire(a.time,a.rate)},fluid.defaults("berg.clock.realtime",{gradeNames:["berg.clock","autoInit"],members:{time:{expander:{"this":performance,method:"now"}}},invokers:{tick:{funcName:"berg.clock.realtime.tick",args:["{that}"]}}}),berg.clock.realtime.tick=function(a){a.time=performance.now(),a.events.onTick.fire(a.time,a.rate)}}(),function(){"use strict";fluid.registerNamespace("berg"),berg.priorityQueue=function(){var a={items:[]};return a.push=function(b){if(b){if(void 0===b.priority)throw new Error("An item without a priority cannot be added to the queue.");a.items.push(b),a.bubbleUp(a.items.length-1)}},a.peek=function(){return a.items[0]},a.pop=function(){var b=a.items[0],c=a.items.pop();return a.items.length>0&&(a.items[0]=c,a.sinkDown(0)),b},a.remove=function(b){for(var c=a.items.length,d=0;c>d;d++)if(a.items[d]==b){var e=a.items.pop();if(d===c-1)break;a.items[d]=e,a.bubbleUp(d),a.sinkDown(d);break}},a.size=function(){return a.items.length},a.clear=function(){a.items.length=0},a.bubbleUp=function(b){for(var c=a.items[b];b>0;){var d=b-1>>1,e=a.items[d];if(e.priority<=c.priority)break;a.items[d]=c,a.items[b]=e,b=d}},a.sinkDown=function(b){for(var c,d=a.items.length,e=a.items[b];;){var f=2*(b+1),g=f-1,h=null;if(d>g&&(c=a.items[g],c.priority<e.priority&&(h=g)),d>f){var i=a.items[f],j=null===h?e:c;i.priority<j.priority&&(h=f)}if(null===h)break;a.items[b]=a.items[h],a.items[h]=e,b=h}},a}}(),function(){"use strict";fluid.defaults("berg.postMessageSender",{gradeNames:["fluid.eventedComponent","autoInit"],members:{messageTarget:self},invokers:{postMessage:"berg.postMessageSender.postMessage({arguments}.0, {arguments}.1, {that}.messageTarget)"}}),berg.postMessageSender.postMessage=function(a,b,c){if("string"!=typeof a)throw new Error("Can't post a message without a message type.");var d={type:a,args:b};c.postMessage(d)},fluid.defaults("berg.postMessageListener",{gradeNames:["fluid.eventedComponent","autoInit"],members:{messageSource:self},events:{onError:null},listeners:{onCreate:["berg.postMessageListener.bind({that})"],onError:[{namespace:"failOnError",funcName:"fluid.fail"}]}}),berg.postMessageListener.bind=function(a){a.messageSource.addEventListener("message",function(b){var c=b.data;c.type||a.events.onError.fire("Received a remote message without a type. "+fluid.prettyPrintJSON(c));var d=a[c.type];a.options.invokers[c.type]&&d||a.events.onError.fire("Received a message of type "+c.type+", which did not resolve to a component invoker. Invokers: "+fluid.prettyPrintJSON(a.options.invokers));var e=fluid.makeArray(c.args);d.apply(null,e)},!1)}}(),function(){"use strict";fluid.defaults("berg.scheduler",{gradeNames:["fluid.standardRelayComponent","autoInit"],members:{queue:"@expand:berg.priorityQueue()"},model:{timeScale:1},components:{clock:{type:"berg.clock.offline"}},invokers:{tick:"berg.scheduler.tick({arguments}.0, {that})",schedule:"berg.scheduler.schedule({arguments}.0, {that})",once:"berg.scheduler.once({arguments}.0, {arguments}.1, {that})",repeat:{funcName:"berg.scheduler.repeat",args:["{arguments}.0","{arguments}.1","{arguments}.2","{arguments}.3","{that}"]},clear:"{that}.queue.remove({arguments}.0)",clearAll:"{that}.queue.clear()",setTimeScale:{changePath:"timeScale",value:"{arguments}.0"},scheduleEvent:"berg.scheduler.scheduleEvent({arguments}.0, {that})",invokeCallback:"berg.scheduler.invokeCallback({arguments}.0, {arguments}.1)"},modelListeners:{timeScale:{funcName:"berg.scheduler.scaleEventTimes",args:["{that}.queue","{change}.value"],excludeSource:"init"}},listeners:{"{clock}.events.onTick":{func:"{scheduler}.tick"}}}),berg.scheduler.calcPriority=function(a,b,c){return a+b*c},berg.scheduler.scaleEventTimes=function(a,b){for(var c=0;c<a.items.length;c++){var d=a.items[c];d.priority=berg.scheduler.calcPriority(d.scheduledAt,d.time,b)}},berg.scheduler.expandRepeatingEventSpec=function(a,b){"number"!=typeof b.time&&(b.time=0),b.interval=1/b.freq,b.end="number"!=typeof b.end?1/0:b.end+a},berg.scheduler.validateEventSpec=function(a){if("function"!=typeof a.callback)throw new Error("No callback was specified for scheduled event: "+fluid.prettyPrintJSON(a));if("repeat"===a.type&&"number"!=typeof a.freq)throw new Error("No freq was specified for scheduled event: "+fluid.prettyPrintJSON(a));if("number"!=typeof a.time)throw new Error("No time was specified for scheduled event: "+fluid.prettyPrintJSON(a))},berg.scheduler.invokeCallback=function(a,b){b.callback(a,b)},berg.scheduler.evaluateScoreEvent=function(a,b,c){c.invokeCallback(a,b),"repeat"===b.type&&b.end>a&&(b.priority=berg.scheduler.calcPriority(a,b.interval,c.model.timeScale),c.queue.push(b))},berg.scheduler.scheduleEvent=function(a,b){var c=b.clock.time,d=b.model.timeScale;return a.type||(a.type="once"),"repeat"===a.type&&berg.scheduler.expandRepeatingEventSpec(c,a),"number"!=typeof a.scheduledAt&&(a.scheduledAt=c),berg.scheduler.validateEventSpec(a),a.priority=berg.scheduler.calcPriority(c,a.time,d),a.priority<=c?berg.scheduler.evaluateScoreEvent(c,a,b):b.queue.push(a),a},berg.scheduler.scheduleEvents=function(a,b){return a.forEach(function(a){b.scheduleEvent(a)}),a},berg.scheduler.schedule=function(a,b){return fluid.isArrayable(a)?berg.scheduler.scheduleEvents(a,b):b.scheduleEvent(a)},berg.scheduler.once=function(a,b,c){var d={type:"once",time:a,callback:b};return c.scheduleEvent(d)},berg.scheduler.repeat=function(a,b,c,d,e){var f={type:"repeat",freq:a,time:c,end:d,callback:b};return e.scheduleEvent(f)},berg.scheduler.tick=function(a,b){for(var c=b.queue.peek();c&&c.priority<=a;)b.queue.pop(),berg.scheduler.evaluateScoreEvent(a,c,b),c=b.queue.peek()}}(),function(){"use strict";fluid.defaults("berg.postMessageSender",{gradeNames:["fluid.eventedComponent","autoInit"],members:{messageTarget:self},invokers:{postMessage:"berg.postMessageSender.postMessage({arguments}, {that}.messageTarget)"}}),berg.postMessageSender.postMessage=function(a,b){var c=a[0];if("string"!=typeof c)throw new Error("Can't post a message without a message type.");var d={type:c,args:a.slice(1)};b.postMessage(d)},fluid.defaults("berg.postMessageListener",{gradeNames:["fluid.eventedComponent","autoInit"],members:{messageSource:self},events:{onError:null},listeners:{onCreate:["berg.postMessageListener.bind({that)"],onError:[{namespace:"failOnError",funcName:"fluid.fail"}]}}),berg.postMessageListener.bind=function(a,b){a.addEventListener("message",function(a){var c=a.data;c.type||b.onError.fire("Received a remote message without a type. "+fluid.prettyPrintJSON(c));var d=that[c.type];that.options.invokers[msgType]&&d||b.onError.fire("Received a message of type "+c.type+", which did not resolve to a component invoker. Invokers: "+fluid.prettyPrintJSON(that.options.invokers)),d.apply(null,c.args)},!1)},fluid.defaults("berg.scheduler.worker",{gradeNames:["berg.scheduler","berg.postMessageSender","autoInit"],invokers:{invokeCallback:"{that}.postMessage(invokeCallback, {arguments}.0, {arguments}.1)"}}),fluid.defaults("berg.scheduler.proxy",{gradeNames:["berg.scheduler","berg.postMessageListener","berg.postMessageSender","autoInit"],members:{callbackMap:{},worker:"@expand:berg.scheduler.proxy.createWorker()",messageTarget:"{that}.worker",messageSource:"{that}.worker"},invokers:{invokeCallback:"berg.scheduler.proxy.invokeCallback({arguments}.0, {arguments}.1, {that})",scheduleEvent:"berg.scheduler.proxy.scheduleEvent({arguments}.0, {that})",clear:"{that}.postMessage(clear, {arguments}.0)",clearAll:"{that}.postMessage(clearAll)",setTimeScale:"{that}.postMessage(setTimeScale, {arguments}.0)"},listeners:{onDestroy:["{that}.postMessage(destroy)",{"this":"{that}.worker",method:"terminate"}]}}),berg.scheduler.proxy.invokeCallback=function(a,b,c){var d=c.callbackMap[a.id];"function"==typeof d?d(b,a):c.events.onError.fire("A callback function was not found for score event: "+fluid.prettyPrintJSON(a))},berg.scheduler.proxy.scheduleEvent=function(a,b){a.id||(a.id=fluid.allocateGuid(),b.callbackMap[a.id]=a.callback),delete a.callback,b.postMessage("scheduleEvent",a)}}(),function(){"use strict";fluid.defaults("berg.clock.raf",{gradeNames:["berg.clock.realtime","autoInit"],rate:60,members:{requestID:null},invokers:{start:{funcName:"berg.clock.raf.requestNextTick",args:["{that}"]},tick:{funcName:"berg.clock.raf.tick",args:["{that}"]},stop:{funcName:"berg.clock.raf.stop",args:["{that}"]}}}),berg.clock.raf.requestNextTick=function(a){a.requestID=requestAnimationFrame(a.tick)},berg.clock.raf.tick=function(a){berg.clock.raf.requestNextTick(a);var b=performance.now();a.time=b,a.events.onTick.fire(b,a.rate)},berg.clock.raf.stop=function(a){cancelAnimationFrame(a.requestID)}}(),function(){"use strict";fluid.defaults("berg.clock.setInterval",{gradeNames:["berg.clock.realtime","autoInit"],members:{intervalID:null},invokers:{start:{funcName:"berg.clock.setInterval.start",args:["{that}"]},stop:{funcName:"berg.clock.setInterval.stop",args:["{that}"]}}}),berg.clock.setInterval.start=function(a){a.intervalID=setInterval(a.tick,1e3/a.options.rate)},berg.clock.setInterval.stop=function(a){clearInterval(a.intervalID)}}(),function(){"use strict";berg.worker=function(a){var b,c,d=typeof a;if("function"===d)a="("+a.toString()+")();";else if("string"!==d)throw new Error("A berg.worker must be initialized with a String or a Function.");return window.Blob?(c=new Blob([a],{type:"text/javascript"}),b=(window.URL||window.webkitURL).createObjectURL(c)):b="data:text/javascript;base64,"+window.btoa(a),new Worker(b)},fluid.defaults("berg.clock.workerSetInterval",{gradeNames:["berg.clock.realtime","berg.postMessageListener","berg.postMessageSender","autoInit"],members:{worker:"@expand:berg.clock.workerSetInterval.initWorker()",messageTarget:"{that}.worker",messageSource:"{that}.worker"},invokers:{start:"{that}.events.onStart.fire",stop:"{that}.events.onStop.fire"},events:{onStart:null,onStop:null},listeners:{onStart:[{func:"{that}.postMessage",args:["start",{rate:"{that}.options.rate"}]}],onStop:["{that}.postMessage(stop)",{"this":"{that}.worker",method:"terminate"}]}}),berg.clock.workerSetInterval.initWorker=function(){return berg.worker(berg.clock.workerSetInterval.workerImpl)},berg.clock.workerSetInterval.workerImpl=function(){var a={};a.workerClock=function(a){var b={options:a||{},intervalID:null};return b.start=function(){b.intervalID=setInterval(b.tick,1e3/b.options.rate)},b.tick=function(){self.postMessage({type:"tick"})},b.stop=function(){clearInterval(b.intervalID)},b},self.addEventListener("message",function(b){"start"===b.data.type?(a.clock=a.workerClock({rate:b.data.value}),a.clock.start()):"stop"===b.data.type&&(a.clock&&a.clock.stop(),self.close())},!1)}}(),function(){"use strict";fluid.defaults("berg.clock.logger",{gradeNames:["fluid.eventedComponent","autoInit"],numTicksToLog:72e3,members:{tickCounter:0,lastTickTime:null,interval:0,intervalLog:"@expand:berg.clock.logger.initLog({that}.options.numTicksToLog)"},invokers:{log:"berg.clock.logger.log({that})"},listeners:{"{clock}.events.onTick":["{that}.log()"]}}),berg.clock.logger.initLog=function(a){return new Float32Array(a)},berg.clock.logger.log=function(a){return null===a.lastTickTime?void(a.lastTickTime=a.time):(a.tickCounter++,a.interval=a.time-a.lastTickTime,void(a.tickCounter<a.options.numTicksToLog&&(a.intervalLog[a.tickCounter]=a.interval)))}}();